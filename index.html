<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub OAuth with PKCE</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 40px auto; padding: 0 20px; }
        h1, h2 { color: #111; }
        button { background-color: #24292e; color: white; border: none; padding: 10px 16px; font-size: 16px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #444; }
        #userInfo, #error { margin-top: 20px; padding: 15px; border-radius: 6px; }
        #userInfo { background-color: #f6f8fa; border: 1px solid #e1e4e8; }
        #error { background-color: #ffeef0; border: 1px solid #f97583; color: #d73a49; }
        pre { background-color: #f6f8fa; padding: 16px; overflow: auto; border-radius: 6px; }
        code { font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; }
    </style>
</head>
<body>

    <h1>GitHub OAuth with PKCE Example</h1>
    <p>This page demonstrates a secure, client-side only GitHub OAuth2 login using the Authorization Code Flow with PKCE.</p>

    <button id="loginButton">Login with GitHub</button>

    <div id="userInfo" style="display:none;">
        <h2>User Information</h2>
        <pre><code id="userData"></code></pre>
    </div>

    <div id="error" style="display:none;"></div>

    <script>
        // https://sleepydev.eu.auth0.com/.well-known/openid-configuration
        // ---------------------------------------------------------------------
        // CONFIGURATION: Replace with your GitHub OAuth App's Client ID
        // ---------------------------------------------------------------------
        const GITHUB_CLIENT_ID = 'XCaSnYut7Tl4ubdR7pKzkjBym19JRoBl';
        const REDIRECT_URI = 'https://sleepydeb.github.io/aws-github-login/index.html';

        const loginButton = document.getElementById('loginButton');
        const userInfoDiv = document.getElementById('userInfo');
        const userDataCode = document.getElementById('userData');
        const errorDiv = document.getElementById('error');

        /**
         * Generates a random string for the code verifier.
         */
        function generateCodeVerifier() {
            const randomBytes = new Uint8Array(32);
            window.crypto.getRandomValues(randomBytes);
            return btoa(String.fromCharCode.apply(null, randomBytes))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        /**
         * Hashes the code verifier to create the code challenge.
         */
        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, new Uint8Array(hashBuffer)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        /**
         * Kicks off the login process by redirecting the user to GitHub.
         */
        async function redirectToGitHub() {
            const codeVerifier = generateCodeVerifier();
            sessionStorage.setItem('code_verifier', codeVerifier); // Store for later use

            const codeChallenge = await generateCodeChallenge(codeVerifier);

            const authUrl = new URL('https://sleepydev.eu.auth0.com/authorize');
            authUrl.searchParams.append('client_id', GITHUB_CLIENT_ID);
            authUrl.searchParams.append('redirect_uri', REDIRECT_URI);
            authUrl.searchParams.append('response_type', 'code');
            authUrl.searchParams.append('scope', 'openid profile email'); // Request read access to user profile
            authUrl.searchParams.append('code_challenge', codeChallenge);
            authUrl.searchParams.append('code_challenge_method', 'S256');

            window.location.href = authUrl.toString();
        }

        /**
         * Exchanges the authorization code for an access token.
         */
        async function getAccessToken(code) {
            const codeVerifier = sessionStorage.getItem('code_verifier');
            if (!codeVerifier) {
                showError("Error: Code verifier not found. Please try logging in again.");
                return;
            }

            // --- START: Changes for the fix ---
            
            // Create the body as URLSearchParams
            const params = new URLSearchParams();
            params.append('client_id', GITHUB_CLIENT_ID);
            params.append('code', code);
            params.append('code_verifier', codeVerifier);
            params.append('redirect_uri', REDIRECT_URI);
            params.append('grant_type', 'authorization_code');            

            const tokenUrl = 'https://sleepydev.eu.auth0.com/oauth/token';

            const response = await fetch(tokenUrl, {
                method: 'POST',
                headers: {
                    // The 'Accept' header tells GitHub to send the response in JSON format.
                    'Accept': 'application/json',
                    // DO NOT set the 'Content-Type' header. 
                    // The browser will automatically set it to 'application/x-www-form-urlencoded' 
                    // when the body is a URLSearchParams object.
                },
                body: params // Use the URLSearchParams object as the body
            });

            // --- END: Changes for the fix ---

            const data = await response.json();

            if (data.error) {
                showError(`Error: ${data.error_description}`);
                return null;
            }
            return data.access_token;
        }
        
        /**
         * Fetches user data from the GitHub API using the access token.
         */
        async function fetchGitHubUser(accessToken) {
            const userUrl = 'https://sleepydev.eu.auth0.com/userinfo';
            const response = await fetch(userUrl, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });
            return await response.json();
        }

        function displayUserInfo(user) {
            loginButton.style.display = 'none';
            userInfoDiv.style.display = 'block';
            userDataCode.textContent = JSON.stringify(user, null, 2);
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // --- Main Logic ---

        loginButton.addEventListener('click', redirectToGitHub);

        // On page load, check if we're coming back from GitHub
        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                // We have a code, so exchange it for an access token
                history.replaceState({}, document.title, window.location.pathname); // Clean up URL
                const accessToken = await getAccessToken(code);
                if (accessToken) {
                    const user = await fetchGitHubUser(accessToken);
                    displayUserInfo(user);
                }
            }
        };
    </script>
</body>
</html>